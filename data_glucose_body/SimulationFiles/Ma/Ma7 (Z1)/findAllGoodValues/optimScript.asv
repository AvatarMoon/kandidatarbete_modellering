%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  GLOBALS AND INTIAL STUFF
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

clear all
close all

global EXPDATA_IR
global EXPDATA_IRS1
global EXPDATA_PKB
global EXPDATA_GLUCOSE_05
global EXPDATA_WB
global pNamesOpt  
global icOrig 
global icOrigWb
global modelName
global modelNameWb
global FID

modelName = 'testmodel';
optModel = SBmodel(strcat(modelName,'.txt'));
tmpModel = optModel;
SBAOcreateMEXmodel(optModel,modelName);

modelNameWb = 'testmodelWb';
optModelWb = SBmodel(strcat(modelNameWb,'.txt'));
tmpModelWb = optModelWb;
SBAOcreateMEXmodel(optModelWb,modelNameWb);

FID = fopen('allGoodValues.dat','wt');

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  CREATE THE EXPDATA STRUCT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

load('EXPDATA_IR.mat');
load('EXPDATA_IRS1.mat');
load('EXPDATA_PKB.mat');
load('EXPDATA_GLUCOSE_05.mat');
load('EXPDATA_WB.mat');

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%          THE OPTIMIZATION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

[pNamesOpt, startGuess] = SBparameters(optModel);
icOrig = SBinitialconditions(optModel);
icOrigWb = SBinitialconditions(optModelWb);

% startGuess = [25163 0.348036 15.3469 7284.46 2.27903e-005 2.27903e-005 0.175064 20 0.2 2500 0.003 0.00033 0.0021 0.0002 1 1 1 1 1 1.67 0.897 0.461 4.16 1.4 10 0.706 1.39 42.1 0.13 2.77 2.96 6.9 6.9 0.167 0.007 0.001155 0.11 1 1 1 0.005 9.09]';
% startGuess = [634206 7381.98 682641 900899 73.7683 1.15769 70132 31238 219391 24674.1 56737.2 7266.12 644755 51086.3 126174 0.946306 0.334218 25528.7 49623 11579.6 35453.8 266431 442584 989745 4742.29 455447 980995 479796 45653.3 453684 121069 455703 50585.3 754366 751106 1.49133 733932 66965.1 0.0063 0.25 0.25 0.104]';
% startGuess = [608085 5128.11 2.06869e+006 848234 716118 547.077 76332.6 2.0699e+006 200203 4.79452e+006 49849 6.54123e+006 3.03974e+006 52415.7 708384 1.27379e+006 0.390064 2.52861e+006 2.9753e+006 6557.79 37043.2 1.29192e+006 1.84708e+006 1.28603e+006 1.25383e+006 351087 1.33181e+006 1.06788e+006 52340.9 989310 1.67408e+006 5.58506e+006 38216.1 687562 1.41395e+006 5.24138e+006 721071 82092.6 106848 593460 0.287319 2.73709e+006 ]';
% startGuess = 1.0e+006 *[0.466635702936855   0.004734807627946   1.482491104623145   0.454554656992758   0.699478303443872   0.017788535653487   0.140356167362583   0.769423843927909   0.532232057183084   3.700927984249626   0.594576905704104   1.978909039120714   0.000777717874558   1.683732880265108   1.342515237283389   0.000888783592544   0.227578506404440   2.365903675039287   0.649964099471410   0.000149088991619   0.000161738091598   6.841213839158746   3.035486516653001   0.332958028467917   0.000005871301795   0.227385201264565   5.350774498563405   0.312242207091689   0.023157262066858   1.617076208561342   1.300641536081874   3.283510971207665   0.029595847083014   1.130741221112398   0.000313083820304   0.000626906492469   0.000000011065354   0.000001183456778   0.054016377311544   4.328472769493861   0.000287189356293   1.927519830586114]';
% startGuess = 1.0e+006 *[0.883451608563966   0.003227675087284   9.860651079364594   0.675337691929882   1.528306413605354   0.021740228556375   0.077257668208983   0.537888206025179   0.766935652809271   9.673240943334360   0.680153262570262   3.863241848014945   0.002737719434575   1.261386145153230   0.489917841783622   0.035913756095494   0.061437284582439   0.491628976319794   0.085355265478017   0.000208235447031   0.000422206635339   2.249262359076901   0.025573296903609   0.023153221974689   0.000051652823333   0.121866867834008   0.013807510138120   0.133086605748884   0.010993756243539   3.469377074713699   1.186508496049425   9.780999618091157   0.005216390882964   0.000418057107271   0.000537279623862   0.000503400046017   0.000000151769444   0.000000187835150   0.396952724650442   7.316573679081349   0.001397453223392   1.595601682394592]';
% startGuess = [883452 3227.68 9.86065e+003 6753.38 1.52831e+006 21740.2 77257.7 537888 766936 9.67324e+006 680153 3.86324e+006 2737.72 1.26139e+006 489918 35913.8 61437.3 491629 85355.3 208.235 422.207 2.24926e+006 25573.3 23153.2 51.6528 121867 13807.5 133087 10993.8 3.46938e+006 1.18651e+006 9.781e+006 5216.39 418.057 537.28 503.4 0.151769 0.187835 396953 7.31657e+006 1397.45 1.5956e+006 ]';
startGuess = [15771.7 22.4271 9809.06 1.09909 2.18705e+006 289.458 3.82006e+006 4.84264e+007 190768 1.85446e+008 99186.2 3.18683e+006 539144 84.9984 1.05985e+006 9.67662 1334.27 1.41102e+007 2.67747e+007 7463.03 25449.6 2.57543e+006 382843 9.88239e+007 6.66662 136448 547.375 457.175 3.58974e+008 6.79807e+006 81707.1 1.94567e+006 1466.29 1.51961e+007 579.694 2367.81 58192.7 4.73877e+007 25793.7 792033 8.77245e+008 2.09588e+006 ]';


startCost = CostFunction(startGuess',0)

OPTIONS = [];
OPTIONS.tempstart = 1e0*startCost;               %InitialTemp
OPTIONS.tempend = 0.5;                           %EndTemp
OPTIONS.tempfactor = 0.1;                        %tempfactor
OPTIONS.maxitertemp = 5*length(startGuess);     %Max-iterations per temp
OPTIONS.maxitertemp0 = 5*length(startGuess);    %Max-iterations at temp0
OPTIONS.maxtime = 2d6;                           %Max-time
OPTIONS.tolx = 1e-10;                            %TolX
OPTIONS.tolfun = 1e-10;                          %Tolfun
OPTIONS.MaxRestartPoints = 1;                    %Number of parallel valleys which are searched through

OPTIONS.lowbounds = [1e-9 1-9 1 1 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9 1e-9];
OPTIONS.highbounds = [1e9 1e9 1e4 1e4 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9 1e9];

OPTIONS.outputFunction ='';
OPTIONS.silent = 0;

format long
format compact

[X,FVAL,EXITFLAG] = simannealingSBAOClustering(@CostFunction,startGuess',OPTIONS)


save 'Result.m' X;

fclose(FID);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%         PLOT THE RESULT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
plotData;
plotSimulation(X(1,:));
